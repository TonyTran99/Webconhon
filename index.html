<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Đối Soát V7 - Gemini AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f8fafc; }
        .scroller::-webkit-scrollbar { width: 8px; }
        .scroller::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        .loader {
            border: 3px solid #f3f3f3; border-top: 3px solid #6366f1; border-radius: 50%;
            width: 24px; height: 24px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-800">

    <header class="bg-indigo-900 text-white px-6 py-3 shadow-lg flex justify-between items-center z-30">
        <div class="flex items-center gap-3">
            <div class="bg-white/10 p-2 rounded-lg backdrop-blur-sm"><i class="fa-solid fa-brain text-yellow-400 text-xl"></i></div>
            <div>
                <h1 class="text-lg font-bold uppercase leading-none tracking-wide">Đối Soát Thông Minh V7</h1>
                <div class="text-[11px] text-indigo-200 mt-1">Powered by Google Gemini 1.5 Flash</div>
            </div>
        </div>
        
        <div class="flex items-center gap-2 bg-indigo-800 p-1 pl-3 rounded-lg border border-indigo-700">
            <i class="fa-solid fa-key text-xs text-indigo-400"></i>
            <input v-model="apiKey" type="password" placeholder="Dán Google API Key vào đây..." class="bg-transparent border-none text-xs text-white placeholder-indigo-400 focus:outline-none w-48">
        </div>
    </header>

    <div id="app" class="flex-1 flex overflow-hidden">
        
        <div class="w-5/12 bg-slate-900 flex flex-col relative border-r border-slate-700">
            <div class="flex-1 overflow-auto scroller flex items-start justify-center p-4 bg-slate-800/50">
                <div v-if="!imageSrc" class="mt-20 border-2 border-dashed border-slate-600 rounded-xl p-10 text-center text-slate-400 hover:bg-slate-800 transition cursor-pointer relative">
                    <i class="fa-solid fa-file-invoice-dollar text-5xl mb-4 opacity-50"></i>
                    <p class="font-bold">Tải ảnh biên lai</p>
                    <p class="text-xs mt-2 opacity-70">Hỗ trợ ảnh dài, ảnh chụp màn hình</p>
                    <input type="file" @change="handleFileUpload" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer">
                </div>
                <img v-else :src="imageSrc" class="max-w-full rounded-lg shadow-2xl border border-slate-600 cursor-zoom-in hover:scale-105 transition duration-300" onclick="this.classList.toggle('scale-[2]')" alt="Receipt">
            </div>
            
            <div class="p-3 bg-slate-900 border-t border-slate-700 flex justify-between items-center text-white text-xs">
                <span><i class="fa-solid fa-info-circle mr-1"></i> Zoom: Click vào ảnh</span>
                <button @click="resetApp" class="hover:text-red-400 transition"><i class="fa-solid fa-trash mr-1"></i> Xóa ảnh</button>
            </div>
        </div>

        <div class="w-7/12 bg-white flex flex-col relative">
            
            <div v-if="isProcessing" class="absolute inset-0 z-50 bg-white/90 backdrop-blur-sm flex flex-col items-center justify-center">
                <div class="loader mb-4 w-12 h-12 border-4 border-t-indigo-600"></div>
                <h3 class="text-lg font-bold text-indigo-900">AI đang phân tích biên lai...</h3>
                <p class="text-sm text-slate-500 mt-2 animate-pulse">Đang trích xuất tên, số tiền và luận giải lô đề...</p>
            </div>

            <div class="flex-1 overflow-y-auto scroller p-6 pb-24">
                
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 mb-6 overflow-hidden group hover:border-indigo-300 transition">
                    <div class="bg-slate-50 border-b px-5 py-3 flex justify-between items-center">
                        <h3 class="font-bold text-sm text-slate-700 uppercase flex items-center gap-2">
                            <span class="bg-blue-100 text-blue-700 w-6 h-6 flex items-center justify-center rounded-full text-xs">1</span>
                            Thông tin giao dịch
                        </h3>
                        <div v-if="isValidHeader" class="text-green-600 text-xs font-bold flex items-center gap-1">
                            <i class="fa-solid fa-check-circle"></i> Đầy đủ
                        </div>
                    </div>
                    <div class="p-5 grid grid-cols-2 gap-5">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Người chuyển (Sender)</label>
                            <input v-model="form.sender_name" class="w-full p-2.5 bg-slate-50 border rounded-lg text-sm font-semibold text-slate-800 focus:bg-white focus:border-indigo-500 outline-none transition" placeholder="...">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Thời gian (Date)</label>
                            <input v-model="form.transaction_date" type="datetime-local" class="w-full p-2.5 bg-slate-50 border rounded-lg text-sm focus:bg-white focus:border-indigo-500 outline-none transition">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Tổng tiền thực chuyển</label>
                            <div class="relative">
                                <input type="text" :value="formatCurrency(form.total_amount)" @input="updateTotal" 
                                    class="w-full p-3 pl-4 border-2 border-indigo-100 bg-indigo-50/50 rounded-xl text-xl font-bold text-indigo-700 text-right pr-12 focus:border-indigo-500 outline-none transition" placeholder="0">
                                <span class="absolute right-4 top-4 text-xs font-bold text-indigo-400">VNĐ</span>
                            </div>
                        </div>
                        
                        <div class="col-span-2 bg-slate-50 rounded-lg p-3 border border-dashed border-slate-300 flex gap-3 text-xs">
                            <div class="flex-1">
                                <label class="block text-[9px] font-bold text-slate-400 uppercase">Người nhận</label>
                                <input v-model="form.receiver_name" class="w-full bg-transparent border-b border-slate-200 focus:border-indigo-500 outline-none py-1 font-medium" placeholder="...">
                            </div>
                            <div class="flex-1">
                                <label class="block text-[9px] font-bold text-slate-400 uppercase">Ngân hàng</label>
                                <input v-model="form.receiver_bank" class="w-full bg-transparent border-b border-slate-200 focus:border-indigo-500 outline-none py-1" placeholder="...">
                            </div>
                            <div class="flex-1">
                                <label class="block text-[9px] font-bold text-slate-400 uppercase">Số TK</label>
                                <input v-model="form.receiver_account" class="w-full bg-transparent border-b border-slate-200 focus:border-indigo-500 outline-none py-1 font-mono" placeholder="...">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 mb-6 overflow-hidden">
                    <div class="bg-gradient-to-r from-indigo-50 to-white border-b px-5 py-3 flex justify-between items-center">
                        <h3 class="font-bold text-sm text-indigo-900 uppercase flex items-center gap-2">
                            <span class="bg-indigo-600 text-white w-6 h-6 flex items-center justify-center rounded-full text-xs">2</span>
                            Chi tiết đặt cược
                        </h3>
                        <div class="text-xs font-bold text-indigo-600 bg-indigo-100 px-2 py-1 rounded">
                            Đã tìm thấy: {{ form.bets.length }} mã
                        </div>
                    </div>

                    <table class="w-full text-sm">
                        <thead class="bg-slate-50 text-slate-500 text-[10px] uppercase border-b">
                            <tr>
                                <th class="p-3 text-left pl-5">Con Vật</th>
                                <th class="p-3 text-right">Tiền cược (k)</th>
                                <th class="p-3 text-right">Thành tiền</th>
                                <th class="p-3 text-center w-10"></th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            <tr v-for="(bet, index) in form.bets" :key="index" class="hover:bg-indigo-50/50 transition group">
                                <td class="p-3 pl-5">
                                    <div class="flex items-center gap-3">
                                        <span class="font-mono font-bold text-lg text-indigo-600 w-8 text-center bg-indigo-50 rounded p-1 border border-indigo-100">{{ bet.code }}</span>
                                        <div>
                                            <div class="font-bold text-slate-700">{{ bet.common_name }}</div>
                                            <div class="text-[10px] text-slate-400 italic">"{{ bet.matched_text }}"</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="p-3 text-right">
                                    <input type="number" v-model="bet.amount_k" class="w-20 text-right p-1.5 border border-slate-200 rounded font-mono text-sm focus:border-indigo-500 focus:bg-white bg-transparent outline-none transition">
                                </td>
                                <td class="p-3 text-right font-mono font-medium text-slate-600">
                                    {{ (bet.amount_k * 1000).toLocaleString('vi-VN') }}
                                </td>
                                <td class="p-3 text-center">
                                    <button @click="removeBet(index)" class="text-slate-300 hover:text-red-500 transition px-2"><i class="fa-solid fa-xmark"></i></button>
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="p-4 bg-slate-50/50 border-t">
                        <div class="text-[10px] font-bold text-slate-400 uppercase mb-2">Thêm thủ công (Nếu AI sót):</div>
                        <div class="grid grid-cols-6 sm:grid-cols-9 gap-1.5 h-24 overflow-y-auto scroller pr-1">
                            <button v-for="animal in animalDb" :key="animal.code" @click="addBet(animal)" 
                                class="bg-white border border-slate-200 hover:border-indigo-500 hover:bg-indigo-50 rounded p-1 flex flex-col items-center transition shadow-sm">
                                <span class="text-[10px] font-bold text-indigo-700">{{ animal.code }}</span>
                                <span class="text-[9px] text-slate-500 truncate w-full text-center">{{ animal.common }}</span>
                            </button>
                        </div>
                    </div>
                </div>

            </div>

            <div class="absolute bottom-0 left-0 right-0 bg-white border-t p-4 shadow-[0_-5px_20px_rgba(0,0,0,0.05)] z-40">
                <div class="flex items-center gap-6">
                    <div class="flex-1">
                        <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Trạng thái đối chiếu</div>
                        <div class="flex items-center gap-3">
                            <span class="text-3xl font-black tracking-tight" :class="diff === 0 ? 'text-emerald-600' : 'text-rose-600'">
                                {{ diff > 0 ? '+' : '' }}{{ diff.toLocaleString('vi-VN') }} ₫
                            </span>
                            <div v-if="diff === 0" class="px-3 py-1 bg-emerald-100 text-emerald-700 text-xs font-bold rounded-full uppercase flex items-center gap-1">
                                <i class="fa-solid fa-check"></i> Khớp lệnh
                            </div>
                            <div v-else class="px-3 py-1 bg-rose-100 text-rose-700 text-xs font-bold rounded-full uppercase flex items-center gap-1">
                                <i class="fa-solid fa-triangle-exclamation"></i> Lệch
                            </div>
                        </div>
                    </div>
                    
                    <button @click="downloadExcel" :disabled="diff !== 0" 
                        class="bg-indigo-600 hover:bg-indigo-700 disabled:bg-slate-300 disabled:cursor-not-allowed text-white px-8 py-4 rounded-xl font-bold shadow-lg shadow-indigo-200 transition-all transform active:scale-95 flex items-center gap-3 text-sm">
                        <span>XÁC NHẬN & TẢI VỀ</span>
                        <i class="fa-solid fa-file-export text-lg"></i>
                    </button>
                </div>
            </div>

        </div>
    </div>

    <script>
        const { createApp } = Vue;

        // DANH SÁCH 36 CON (Reference cho AI và UI)
        const ANIMAL_DB = [
            {code:'01', common:'Cá Trắng', alias:'Chiếm Khôi'}, {code:'02', common:'Con Ốc', alias:'Bản Quế'},
            {code:'03', common:'Con Ngỗng', alias:'Vinh Sanh'}, {code:'04', common:'Con Công', alias:'Yên Thế'},
            {code:'05', common:'Con Trùng', alias:'Chí Cao'}, {code:'06', common:'Con Gà', alias:'Phú Quí'},
            {code:'07', common:'Con Heo', alias:'Hữu Dụng'}, {code:'08', common:'Con Dương', alias:'Thái Bình'},
            {code:'09', common:'Con Trâu', alias:'Thành Thang'}, {code:'10', common:'Rồng Bay', alias:'Giang Từ'},
            {code:'11', common:'Con Chó', alias:'Hà Bao'}, {code:'12', common:'Con Ngựa', alias:'Thanh Liêm'},
            {code:'13', common:'Con Voi', alias:'Hòa Bình'}, {code:'14', common:'Con Mèo', alias:'Tư Hiền'},
            {code:'15', common:'Con Chuột', alias:'An Khánh'}, {code:'16', common:'Con Ong', alias:'Nhật Sơn'},
            {code:'17', common:'Hạc Tiên', alias:'Chỉ Đắc'}, {code:'18', common:'Con Cọp', alias:'Khổng Minh'},
            {code:'19', common:'Con Bướm', alias:'Vãng Sanh'}, {code:'20', common:'Con Rùa', alias:'Nguyên Cát'},
            {code:'21', common:'Con Én', alias:'Thượng Chiêu'}, {code:'22', common:'Con Cu', alias:'Song Đồng'},
            {code:'23', common:'Con Khỉ', alias:'Phước Tôn'}, {code:'24', common:'Con Ếch', alias:'Lưu Bị'},
            {code:'25', common:'Con Ó', alias:'Thượng Cầm'}, {code:'26', common:'Rồng Nước', alias:'Hạ Động'},
            {code:'27', common:'Con Quy', alias:'Cao Sỹ'}, {code:'28', common:'Con Gà', alias:'Bạch Lợi'},
            {code:'29', common:'Con Lươn', alias:'Trúc Thanh'}, {code:'30', common:'Cá Đỏ', alias:'Tỉnh Lợi'},
            {code:'31', common:'Con Tôm', alias:'Cẩm Chương'}, {code:'32', common:'Con Rắn', alias:'Phùng Xuân'},
            {code:'33', common:'Con Nhện', alias:'Tây Phương'}, {code:'34', common:'Con Nai', alias:'Thuận Lợi'},
            {code:'35', common:'Con Dê', alias:'Vĩnh Thái'}, {code:'36', common:'Con Yêu', alias:'An Sỹ'}
        ];

        createApp({
            data() {
                return {
                    apiKey: localStorage.getItem('gemini_api_key') || '',
                    imageSrc: null,
                    isProcessing: false,
                    animalDb: ANIMAL_DB,
                    form: {
                        sender_name: '', transaction_date: '', total_amount: 0,
                        receiver_name: '', receiver_bank: '', receiver_account: '',
                        bets: []
                    }
                }
            },
            watch: {
                apiKey(newVal) { localStorage.setItem('gemini_api_key', newVal); }
            },
            computed: {
                sumBets() { return this.form.bets.reduce((acc, b) => acc + (b.amount_k || 0) * 1000, 0); },
                diff() { return (this.form.total_amount || 0) - this.sumBets; },
                isValidHeader() { return this.form.sender_name && this.form.total_amount > 0; }
            },
            methods: {
                async handleFileUpload(e) {
                    const file = e.target.files[0];
                    if(!file) return;
                    if(!this.apiKey) return alert("Vui lòng nhập Google API Key trước!");

                    this.imageSrc = URL.createObjectURL(file);
                    this.isProcessing = true;
                    
                    try {
                        // 1. Convert Image to Base64
                        const base64Image = await this.fileToGenerativePart(file);
                        
                        // 2. Call Gemini API
                        await this.analyzeImage(base64Image);

                    } catch (error) {
                        alert("Lỗi AI: " + error.message);
                    } finally {
                        this.isProcessing = false;
                    }
                },

                async analyzeImage(imagePart) {
                    // PROMPT THÔNG MINH
                    const promptText = `
                    Bạn là trợ lý xử lý dữ liệu biên lai chuyển khoản ngân hàng Việt Nam.
                    Nhiệm vụ: Trích xuất thông tin JSON từ hình ảnh biên lai.
                    
                    Quy tắc xử lý nội dung cược (quan trọng):
                    - Đọc phần nội dung chuyển khoản (message/note).
                    - Tìm các con vật dựa trên danh sách 36 con sau (Code - Tên thường - Tên huý):
                    ${JSON.stringify(this.animalDb.map(a => `${a.code}-${a.common}-${a.alias}`).join(', '))}
                    - Nếu nội dung chứa tên thường hoặc tên huý hoặc số code, hãy map về đúng con vật.
                    - Số tiền: "50" hoặc "50k" đều hiểu là 50 (đơn vị nghìn). Nếu "50000" thì chia 1000 thành 50.
                    
                    Output JSON format (chỉ trả về JSON thuần, không markdown):
                    {
                        "sender_name": "Tên người chuyển (viết hoa)",
                        "transaction_date": "YYYY-MM-DDTHH:mm (nếu có)",
                        "total_amount": Number (số nguyên, ví dụ 150000),
                        "receiver_name": "Tên người nhận",
                        "receiver_bank": "Ngân hàng nhận",
                        "receiver_account": "Số TK nhận",
                        "bets": [
                            {
                                "code": "Mã con (01-36)",
                                "common_name": "Tên thường",
                                "matched_text": "Từ khoá tìm thấy trong ảnh",
                                "amount_k": Number (đơn vị nghìn, vd 50)
                            }
                        ]
                    }
                    `;

                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${this.apiKey}`;
                    
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: promptText }, imagePart] }]
                        })
                    });

                    const data = await response.json();
                    if(data.error) throw new Error(data.error.message);

                    // Parse JSON response
                    let textRes = data.candidates[0].content.parts[0].text;
                    // Clean markdown code blocks if present
                    textRes = textRes.replace(/```json/g, '').replace(/```/g, '').trim();
                    
                    const result = JSON.parse(textRes);
                    
                    // Map data to Form
                    this.form.sender_name = result.sender_name || '';
                    this.form.transaction_date = result.transaction_date || new Date().toISOString().slice(0,16);
                    this.form.total_amount = result.total_amount || 0;
                    this.form.receiver_name = result.receiver_name || '';
                    this.form.receiver_bank = result.receiver_bank || '';
                    this.form.receiver_account = result.receiver_account || '';
                    this.form.bets = result.bets || [];
                },

                fileToGenerativePart(file) {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onloadend = () => {
                            const base64String = reader.result.split(',')[1];
                            resolve({ inlineData: { data: base64String, mimeType: file.type } });
                        };
                        reader.readAsDataURL(file);
                    });
                },

                // UI Helpers
                resetApp() {
                    this.imageSrc = null;
                    this.form = { sender_name: '', transaction_date: '', total_amount: 0, bets: [] };
                },
                formatCurrency(val) { return val ? val.toLocaleString('vi-VN') : ''; },
                updateTotal(e) {
                    const raw = e.target.value.replace(/[^0-9]/g, '');
                    this.form.total_amount = raw ? parseInt(raw) : 0;
                },
                addBet(animal) {
                    this.form.bets.push({ code: animal.code, common_name: animal.common, matched_text: 'Thủ công', amount_k: 0 });
                },
                removeBet(idx) { this.form.bets.splice(idx, 1); },
                
                downloadExcel() {
                    let csv = "\uFEFFNgay,NguoiChuyen,NguoiNhan,NganHang,SoTK,TongTien,Ma,ConVat,Tien(k),ThanhTien\n";
                    const d = this.form.transaction_date.replace('T', ' ');
                    this.form.bets.forEach(b => {
                        csv += `"${d}","${this.form.sender_name}","${this.form.receiver_name}","${this.form.receiver_bank}","${this.form.receiver_account}",${this.form.total_amount},'${b.code},"${b.common_name}",${b.amount_k},${b.amount_k*1000}\n`;
                    });
                    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement("a");
                    link.href = url;
                    link.download = `BienLai_${this.form.sender_name}_${Date.now()}.csv`;
                    link.click();
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
