<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Đối Chiếu - Giao Diện Dọc</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Tùy chỉnh thanh cuộn cho mượt */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        body { font-family: 'Segoe UI', sans-serif; }
        
        /* Hiệu ứng zoom kính lúp */
        .magnifier {
            cursor: zoom-in;
            transition: transform 0.2s;
            transform-origin: top center;
        }
        .magnifier:active {
            transform: scale(1.5); /* Click giữ để zoom */
            cursor: grabbing;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden text-slate-800">

    <header class="bg-blue-900 text-white px-4 py-3 shadow-md flex justify-between items-center z-30 shrink-0">
        <div class="flex items-center gap-3">
            <i class="fa-solid fa-mobile-screen text-2xl text-yellow-400"></i>
            <div>
                <h1 class="text-lg font-bold uppercase leading-tight">Xử Lý Biên Lai Mobile</h1>
                <div class="text-[10px] opacity-80">Hỗ trợ ảnh dọc • Trích xuất full nội dung</div>
            </div>
        </div>
        <div class="text-xs font-mono bg-blue-800 px-2 py-1 rounded">
            v3.0.1
        </div>
    </header>

    <div id="app" class="flex-1 flex overflow-hidden">
        
        <div class="w-5/12 bg-gray-800 border-r border-gray-600 flex flex-col relative shadow-inner">
            <div class="bg-gray-900 text-gray-300 p-2 flex justify-between items-center text-xs shrink-0 z-10">
                <span><i class="fa-regular fa-image mr-1"></i> Bản xem trước</span>
                <div class="flex gap-2">
                    <button @click="rotateImage" class="hover:text-white"><i class="fa-solid fa-rotate-right"></i> Xoay</button>
                    <button @click="resetApp" class="hover:text-red-400"><i class="fa-solid fa-trash"></i> Xóa ảnh</button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto overflow-x-hidden relative text-center p-4 custom-scrollbar bg-gray-700">
                <div v-if="!imageSrc" class="h-full flex flex-col items-center justify-center border-2 border-dashed border-gray-500 rounded-lg opacity-50">
                    <i class="fa-solid fa-cloud-arrow-up text-5xl mb-2"></i>
                    <p>Kéo thả hoặc chọn ảnh biên lai</p>
                    <input type="file" @change="handleFileUpload" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer">
                </div>
                
                <img v-else :src="imageSrc" 
                     :style="{ transform: `rotate(${rotation}deg)` }"
                     class="magnifier max-w-full h-auto mx-auto shadow-2xl rounded-sm border border-gray-500" 
                     alt="Receipt Image" 
                     title="Click giữ chuột để phóng to">
            </div>
        </div>

        <div class="w-7/12 bg-white flex flex-col h-full relative z-20">
            
            <div class="flex-1 overflow-y-auto custom-scrollbar p-6 pb-32"> <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6 shadow-sm">
                    <h3 class="text-xs font-bold text-blue-800 uppercase mb-3 flex items-center">
                        <i class="fa-solid fa-circle-info mr-2"></i> Thông tin giao dịch
                    </h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-3">
                            <div>
                                <label class="block text-[11px] font-bold text-gray-500 uppercase">Họ tên khách (Người chuyển)</label>
                                <input v-model="form.senderName" class="w-full p-2 text-sm border rounded focus:ring-2 focus:ring-blue-500 font-semibold" placeholder="VD: NGUYEN VAN A">
                            </div>
                            <div>
                                <label class="block text-[11px] font-bold text-gray-500 uppercase">Ngày giờ chuyển</label>
                                <input type="datetime-local" v-model="form.transDate" class="w-full p-2 text-sm border rounded focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-[11px] font-bold text-gray-500 uppercase">Tổng tiền thực chuyển</label>
                                <div class="relative">
                                    <input type="text" :value="formatCurrency(form.receiptTotal)" @input="updateTotal" class="w-full p-2 text-lg border border-red-200 bg-red-50 rounded focus:ring-2 focus:ring-red-500 font-bold text-red-600 text-right pr-8" placeholder="0">
                                    <span class="absolute right-3 top-3 text-xs font-bold text-red-400">VNĐ</span>
                                </div>
                            </div>
                            <div class="flex items-center justify-end h-full pt-4">
                                <span v-if="diff === 0 && form.receiptTotal > 0" class="text-green-600 font-bold flex items-center text-sm bg-green-100 px-3 py-1 rounded-full border border-green-200">
                                    <i class="fa-solid fa-check-circle mr-2"></i> Khớp lệnh
                                </span>
                                <span v-else-if="form.receiptTotal > 0" class="text-red-600 font-bold flex items-center text-sm bg-red-100 px-3 py-1 rounded-full border border-red-200">
                                    <i class="fa-solid fa-triangle-exclamation mr-2"></i> Lệch tiền
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 border border-gray-200 rounded-xl p-4 mb-6 shadow-sm">
                    <h3 class="text-xs font-bold text-gray-600 uppercase mb-3 flex items-center">
                        <i class="fa-solid fa-file-invoice mr-2"></i> Nội dung & Người nhận
                    </h3>
                    <div class="grid grid-cols-12 gap-4">
                        <div class="col-span-12">
                            <label class="block text-[10px] text-gray-400 font-bold mb-1">Nội dung ghi trên biên lai (Raw):</label>
                            <textarea class="w-full text-xs p-2 border rounded bg-white text-gray-600 italic h-12" placeholder="VD: con cu 50k, ca trang 50..."></textarea>
                        </div>
                        <div class="col-span-4">
                            <label class="block text-[10px] font-bold text-gray-500">Tên người nhận</label>
                            <input v-model="form.receiverName" class="w-full p-2 text-xs border rounded bg-white font-medium" placeholder="Tên chủ TK">
                        </div>
                        <div class="col-span-4">
                            <label class="block text-[10px] font-bold text-gray-500">Số tài khoản</label>
                            <input v-model="form.receiverAcc" class="w-full p-2 text-xs border rounded bg-white font-mono" placeholder="STK">
                        </div>
                        <div class="col-span-4">
                            <label class="block text-[10px] font-bold text-gray-500">Ngân hàng</label>
                            <input v-model="form.receiverBank" class="w-full p-2 text-xs border rounded bg-white" placeholder="VD: MB, VCB">
                        </div>
                    </div>
                </div>

                <div class="border border-gray-200 rounded-xl overflow-hidden shadow-sm">
                    <div class="bg-indigo-600 text-white px-4 py-2 text-xs font-bold uppercase flex justify-between items-center">
                        <span><i class="fa-solid fa-list-ol mr-2"></i> Chi tiết đặt cược</span>
                        <span>Tổng cược: {{ sumBets.toLocaleString('vi-VN') }} ₫</span>
                    </div>
                    
                    <table class="w-full text-sm">
                        <thead class="bg-gray-100 text-gray-500 text-[11px] uppercase">
                            <tr>
                                <th class="p-3 text-left w-12">Mã</th>
                                <th class="p-3 text-left">Tên (Thường / Huý)</th>
                                <th class="p-3 text-right">Tiền (k)</th>
                                <th class="p-3 text-right">Thành tiền</th>
                                <th class="p-3 text-center w-10"></th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100 bg-white">
                            <tr v-for="(bet, index) in form.bets" :key="index" class="hover:bg-indigo-50 transition">
                                <td class="p-3 font-bold text-indigo-600 text-center border-r">{{ bet.code }}</td>
                                <td class="p-3">
                                    <span class="font-bold text-gray-800">{{ bet.common }}</span>
                                    <span class="text-xs text-gray-400 ml-2">({{ bet.alias }})</span>
                                </td>
                                <td class="p-3 text-right">
                                    <input type="number" v-model="bet.amount_k" class="w-16 text-right p-1 border rounded font-mono text-sm focus:border-indigo-500 focus:bg-white bg-gray-50">
                                </td>
                                <td class="p-3 text-right font-mono font-medium">
                                    {{ (bet.amount_k * 1000).toLocaleString('vi-VN') }}
                                </td>
                                <td class="p-3 text-center">
                                    <button @click="removeBet(index)" class="text-gray-300 hover:text-red-500"><i class="fa-solid fa-times"></i></button>
                                </td>
                            </tr>
                            <tr v-if="form.bets.length === 0">
                                <td colspan="5" class="py-8 text-center text-gray-400 text-xs italic">
                                    Chưa có dữ liệu. Chọn con vật bên dưới.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="mt-4">
                    <p class="text-[10px] font-bold text-gray-400 uppercase mb-2">Thêm nhanh con vật:</p>
                    <div class="grid grid-cols-6 sm:grid-cols-9 gap-1">
                         <button v-for="animal in animalDb" :key="animal.code" @click="addBet(animal)" 
                            class="bg-white border hover:border-indigo-500 hover:bg-indigo-50 rounded py-1 px-1 flex flex-col items-center transition">
                            <span class="font-bold text-[10px] text-indigo-800">{{ animal.code }}</span>
                            <span class="text-[9px] text-gray-600 truncate w-full text-center">{{ animal.common }}</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="absolute bottom-0 left-0 right-0 bg-white border-t p-4 shadow-lg z-30 flex gap-3 items-center">
                <div class="flex-1">
                    <div class="text-[10px] text-gray-500 font-bold uppercase">Chênh lệch đối chiếu</div>
                    <div class="text-xl font-black" :class="diff === 0 ? 'text-green-600' : 'text-red-600'">
                        {{ diff > 0 ? '+' : '' }}{{ diff.toLocaleString('vi-VN') }} ₫
                    </div>
                </div>
                
                <button @click="simulateOCR" class="bg-yellow-100 text-yellow-800 px-3 py-2 rounded text-xs font-bold border border-yellow-300 hover:bg-yellow-200">
                    <i class="fa-solid fa-robot"></i> Test OCR
                </button>

                <button @click="downloadExcel" :disabled="diff !== 0" 
                    class="bg-indigo-700 hover:bg-indigo-800 disabled:bg-gray-300 disabled:cursor-not-allowed text-white px-6 py-3 rounded-lg font-bold shadow-lg flex items-center gap-2 transition-all w-1/2 justify-center">
                    <i class="fa-solid fa-file-export"></i> 
                    <span>XÁC NHẬN</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        
        // DỮ LIỆU SEED (Rút gọn cho demo, thực tế cần đủ 36 con)
        const ANIMAL_DB = [
            {code:'01', alias:'Chiếm Khôi', common:'Cá Trắng'}, {code:'02', alias:'Bản Quế', common:'Con Ốc'},
            {code:'03', alias:'Vinh Sanh', common:'Con Ngỗng'}, {code:'10', alias:'Giang Từ', common:'Rồng Bay'},
            {code:'18', alias:'Khổng Minh', common:'Con Cọp'}, {code:'22', alias:'Song Đồng', common:'Con Cu'},
            {code:'36', alias:'An Sỹ', common:'Con Yêu'}
        ];

        createApp({
            data() {
                return {
                    imageSrc: null,
                    rotation: 0,
                    animalDb: ANIMAL_DB,
                    form: {
                        senderName: '',
                        transDate: '', // YYYY-MM-DDTHH:mm
                        receiptTotal: 0,
                        receiverName: '',
                        receiverBank: '',
                        receiverAcc: '',
                        bets: []
                    }
                }
            },
            computed: {
                sumBets() {
                    return this.form.bets.reduce((acc, bet) => acc + (bet.amount_k || 0) * 1000, 0);
                },
                diff() {
                    return (this.form.receiptTotal || 0) - this.sumBets;
                }
            },
            methods: {
                formatCurrency(value) {
                    if (!value) return '';
                    return value.toLocaleString('vi-VN');
                },
                updateTotal(event) {
                    const raw = event.target.value.replace(/[^0-9]/g, '');
                    this.form.receiptTotal = raw ? parseInt(raw) : 0;
                },
                handleFileUpload(event) {
                    const file = event.target.files[0];
                    if (file) {
                        this.imageSrc = URL.createObjectURL(file);
                        this.rotation = 0;
                        this.resetForm();
                    }
                },
                rotateImage() {
                    this.rotation += 90;
                },
                resetForm() {
                    this.form.senderName = '';
                    this.form.receiptTotal = 0;
                    this.form.bets = [];
                    this.form.receiverName = '';
                    this.form.receiverBank = '';
                    this.form.receiverAcc = '';
                    
                    // Set default date to now
                    const now = new Date();
                    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                    this.form.transDate = now.toISOString().slice(0,16);
                },
                resetApp() {
                    this.imageSrc = null;
                    this.resetForm();
                },
                addBet(animal, amount = 0) {
                    this.form.bets.push({
                        code: animal.code,
                        common: animal.common,
                        alias: animal.alias,
                        amount_k: amount
                    });
                },
                removeBet(index) {
                    this.form.bets.splice(index, 1);
                },
                
                // GIẢ LẬP TRÍCH XUẤT OCR (Bao gồm đầy đủ trường bạn yêu cầu)
                simulateOCR() {
                    alert("Giả lập AI đọc biên lai...");
                    
                    // 1. Trích xuất thông tin chung
                    this.form.senderName = "TRAN THI THU THUY";
                    this.form.transDate = "2023-10-25T14:30";
                    this.form.receiptTotal = 150000;
                    
                    // 2. Trích xuất thông tin người nhận (từ nội dung biên lai)
                    this.form.receiverName = "NGUYEN VAN A";
                    this.form.receiverBank = "VIETCOMBANK";
                    this.form.receiverAcc = "9999888877";

                    // 3. Trích xuất nội dung cược
                    this.form.bets = [];
                    // Case: Tên huý + Tên thường
                    this.addBet(this.animalDb.find(a => a.code === '01'), 50); // Chiếm Khôi 50k
                    this.addBet(this.animalDb.find(a => a.code === '22'), 100); // Con Cu 100k
                },

                downloadExcel() {
                    // Xuất Excel với đầy đủ cột theo yêu cầu
                    let csv = "\uFEFF"; // BOM for Vietnamese characters
                    csv += "Ngay_Gio_Chuyen,Nguoi_Chuyen,Nguoi_Nhan,Ngan_Hang,STK_Nhan,Tong_Tien,Ma_Con,Ten_Thuong,Ten_Huy,Tien_Cuoc(k),Thanh_Tien\n";
                    
                    this.form.bets.forEach(bet => {
                        const row = [
                            `"${this.form.transDate.replace('T', ' ')}"`,
                            `"${this.form.senderName}"`,
                            `"${this.form.receiverName}"`,
                            `"${this.form.receiverBank}"`,
                            `"${this.form.receiverAcc}"`,
                            this.form.receiptTotal,
                            `'${bet.code}`,
                            `"${bet.common}"`,
                            `"${bet.alias}"`,
                            bet.amount_k,
                            bet.amount_k * 1000
                        ].join(",");
                        csv += row + "\n";
                    });

                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement("a");
                    link.href = URL.createObjectURL(blob);
                    link.download = `BienLai_${this.form.senderName}_${Date.now()}.csv`;
                    link.click();
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
