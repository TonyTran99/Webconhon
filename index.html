<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Đối Soát V8 (Bản Chuẩn)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f1f5f9; }
        .scroller::-webkit-scrollbar { width: 8px; }
        .scroller::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%;
            width: 30px; height: 30px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-800">

    <header class="bg-indigo-900 text-white px-4 py-3 shadow-lg flex justify-between items-center z-50">
        <div class="flex items-center gap-3">
            <div class="bg-white/10 p-2 rounded"><i class="fa-solid fa-robot text-yellow-400 text-xl"></i></div>
            <div>
                <h1 class="text-lg font-bold uppercase leading-none">Đối Soát Biên Lai V8</h1>
                <div class="text-[11px] text-indigo-200 mt-1">Dữ liệu chuẩn 36 con theo ảnh gốc</div>
            </div>
        </div>
        
        <div class="flex items-center gap-2 bg-indigo-800 p-1.5 rounded border border-indigo-600">
            <i class="fa-solid fa-key text-xs text-indigo-300 ml-2"></i>
            <input v-model="apiKey" type="password" placeholder="Dán khoá API (AIza...) vào đây" 
                class="bg-transparent border-none text-xs text-white placeholder-indigo-400 focus:outline-none w-64 px-2">
            <div v-if="apiKey && apiKey.startsWith('AIza')" class="text-green-400 text-xs px-2"><i class="fa-solid fa-check"></i></div>
        </div>
    </header>

    <div id="app" class="flex-1 flex overflow-hidden">
        
        <div class="w-5/12 bg-slate-900 flex flex-col relative border-r border-slate-700">
            <div class="flex-1 overflow-auto scroller flex items-center justify-center p-4 bg-slate-800/50">
                <div v-if="!imageSrc" class="text-center border-2 border-dashed border-slate-600 rounded-xl p-10 hover:bg-slate-800 transition cursor-pointer relative group">
                    <i class="fa-solid fa-cloud-arrow-up text-5xl text-slate-500 mb-4 group-hover:text-indigo-400 transition"></i>
                    <p class="text-slate-400 font-bold group-hover:text-white">Tải ảnh biên lai lên</p>
                    <input type="file" @change="handleFileUpload" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer">
                </div>
                <img v-else :src="imageSrc" class="max-w-full max-h-full rounded shadow-2xl border border-slate-600" alt="Receipt">
            </div>
            
            <div class="p-2 bg-slate-950 text-center">
                <button @click="resetApp" class="text-xs text-red-400 hover:text-red-300"><i class="fa-solid fa-trash mr-1"></i> Xóa ảnh & Làm lại</button>
            </div>
        </div>

        <div class="w-7/12 bg-white flex flex-col relative">
            
            <div v-if="isProcessing" class="absolute inset-0 z-50 bg-white/90 backdrop-blur-sm flex flex-col items-center justify-center">
                <div class="loader mb-4"></div>
                <h3 class="text-lg font-bold text-indigo-900">AI Đang Xử Lý...</h3>
                <p class="text-sm text-slate-500">Đang đọc biên lai và đối chiếu 36 con vật</p>
            </div>

            <div v-if="errorMessage" class="absolute top-4 left-4 right-4 z-50 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative shadow-lg">
                <strong class="font-bold">Lỗi: </strong>
                <span class="block sm:inline">{{ errorMessage }}</span>
                <span class="absolute top-0 bottom-0 right-0 px-4 py-3" @click="errorMessage = ''">
                    <i class="fa-solid fa-xmark cursor-pointer"></i>
                </span>
            </div>

            <div class="flex-1 overflow-y-auto scroller p-6 pb-24">
                
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 mb-6">
                    <div class="bg-slate-50 border-b px-4 py-2 flex justify-between items-center">
                        <h3 class="font-bold text-sm text-slate-700 uppercase">1. Thông tin giao dịch</h3>
                        <div v-if="form.sender_name && form.total_amount" class="text-green-600 text-xs font-bold"><i class="fa-solid fa-check"></i> Đã nhận diện</div>
                    </div>
                    <div class="p-4 grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Người chuyển</label>
                            <input v-model="form.sender_name" class="w-full p-2 border rounded text-sm font-bold text-slate-800 focus:border-indigo-500 outline-none" placeholder="...">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Ngày giờ</label>
                            <input v-model="form.transaction_date" type="datetime-local" class="w-full p-2 border rounded text-sm outline-none">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Tổng tiền biên lai</label>
                            <div class="relative">
                                <input type="text" :value="formatCurrency(form.total_amount)" @input="updateTotal" 
                                    class="w-full p-3 border-2 border-indigo-100 bg-indigo-50 rounded-lg text-xl font-bold text-indigo-700 text-right pr-10 focus:border-indigo-500 outline-none" placeholder="0">
                                <span class="absolute right-3 top-4 text-xs font-bold text-indigo-400">VNĐ</span>
                            </div>
                        </div>
                        
                        <div class="col-span-2 grid grid-cols-3 gap-2 mt-2">
                            <input v-model="form.receiver_name" class="p-2 border rounded text-xs" placeholder="Tên người nhận">
                            <input v-model="form.receiver_bank" class="p-2 border rounded text-xs" placeholder="Ngân hàng">
                            <input v-model="form.receiver_account" class="p-2 border rounded text-xs" placeholder="Số tài khoản">
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 mb-6">
                    <div class="bg-indigo-50 border-b px-4 py-2 flex justify-between items-center">
                        <h3 class="font-bold text-sm text-indigo-900 uppercase">2. Chi tiết cược</h3>
                        <span class="text-xs font-bold bg-white text-indigo-600 px-2 py-0.5 rounded border">SL: {{ form.bets.length }}</span>
                    </div>

                    <table class="w-full text-sm">
                        <thead class="bg-slate-50 text-slate-500 text-[10px] uppercase border-b">
                            <tr>
                                <th class="p-3 text-left">Mã / Tên</th>
                                <th class="p-3 text-right">Tiền (k)</th>
                                <th class="p-3 text-right">Thành tiền</th>
                                <th class="p-3 text-center w-10"></th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            <tr v-for="(bet, index) in form.bets" :key="index" class="hover:bg-slate-50">
                                <td class="p-3">
                                    <div class="flex items-center gap-2">
                                        <span class="font-bold text-indigo-700 w-6 text-center bg-indigo-100 rounded">{{ bet.code }}</span>
                                        <div>
                                            <div class="font-bold text-slate-700">{{ bet.common_name }}</div>
                                            <div class="text-[10px] text-slate-400 italic">{{ bet.matched_text }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="p-3 text-right">
                                    <input type="number" v-model="bet.amount_k" class="w-20 text-right p-1 border rounded bg-slate-50 focus:bg-white outline-none">
                                </td>
                                <td class="p-3 text-right font-mono text-slate-600">
                                    {{ (bet.amount_k * 1000).toLocaleString('vi-VN') }}
                                </td>
                                <td class="p-3 text-center">
                                    <button @click="removeBet(index)" class="text-slate-300 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="p-3 bg-slate-50 border-t">
                        <div class="text-[10px] font-bold text-slate-400 uppercase mb-2">Thêm nhanh (Click chọn):</div>
                        <div class="grid grid-cols-6 sm:grid-cols-9 gap-1 h-32 overflow-y-auto scroller pr-1">
                            <button v-for="animal in animalDb" :key="animal.code" @click="addBet(animal)" 
                                class="bg-white border hover:border-indigo-500 hover:bg-indigo-100 rounded p-1 flex flex-col items-center transition shadow-sm">
                                <span class="text-[10px] font-bold text-indigo-700">{{ animal.code }}</span>
                                <span class="text-[9px] text-slate-500 truncate w-full text-center">{{ animal.common }}</span>
                            </button>
                        </div>
                    </div>
                </div>

            </div>

            <div class="absolute bottom-0 left-0 right-0 bg-white border-t p-4 shadow-lg z-40 flex items-center gap-4">
                <div class="flex-1">
                    <div class="text-[10px] font-bold text-slate-400 uppercase">Chênh lệch</div>
                    <div class="flex items-center gap-2">
                        <span class="text-2xl font-black" :class="diff === 0 ? 'text-green-600' : 'text-red-600'">
                            {{ diff > 0 ? '+' : '' }}{{ diff.toLocaleString('vi-VN') }} ₫
                        </span>
                        <span v-if="diff === 0" class="px-2 py-0.5 bg-green-100 text-green-700 text-[10px] font-bold rounded uppercase">Khớp</span>
                        <span v-else class="px-2 py-0.5 bg-red-100 text-red-700 text-[10px] font-bold rounded uppercase">Lệch</span>
                    </div>
                </div>
                
                <button @click="downloadExcel" :disabled="diff !== 0" 
                    class="bg-indigo-600 hover:bg-indigo-700 disabled:bg-slate-300 disabled:cursor-not-allowed text-white px-6 py-3 rounded-lg font-bold shadow-lg transition-all flex items-center gap-2">
                    <span>XÁC NHẬN</span>
                    <i class="fa-solid fa-file-arrow-down"></i>
                </button>
            </div>

        </div>
    </div>

    <script>
        const { createApp } = Vue;

        // DỮ LIỆU CHUẨN HOÁ TỪ ẢNH BẠN GỬI (ĐÃ KIỂM TRA LẠI)
        const ANIMAL_DB = [
            {code:'01', alias:'Chiếm Khôi', common:'Cá Trắng', sub:'05'},
            {code:'02', alias:'Bản Quế', common:'Con Ốc', sub:'16'},
            {code:'03', alias:'Vinh Sanh', common:'Con Ngỗng', sub:'32'},
            {code:'04', alias:'Phùng Xuân', common:'Con Công', sub:'12'},
            {code:'05', alias:'Chí Cao', common:'Con Trùng', sub:'01'},
            {code:'06', alias:'Khôn Sơn', common:'Con Cọp', sub:'17'},
            {code:'07', alias:'Chánh Thuận', common:'Con Heo', sub:'24'},
            {code:'08', alias:'Nguyệt Bửu', common:'Con Thỏ', sub:'20'},
            {code:'09', alias:'Hớn Vân', common:'Con Trâu', sub:'33'},
            {code:'10', alias:'Giang Từ', common:'Rồng Bay', sub:'18'},
            {code:'11', alias:'Phước Tôn', common:'Con Chó', sub:'15'},
            {code:'12', alias:'Quang Minh', common:'Con Ngựa', sub:'04'},
            {code:'13', alias:'Hữu Tài', common:'Con Voi', sub:'14'},
            {code:'14', alias:'Chỉ Đắc', common:'Con Mèo', sub:'13'},
            {code:'15', alias:'Tất Khắc', common:'Con Chuột', sub:'11'},
            {code:'16', alias:'Mậu Lâm', common:'Con Ong', sub:'02'},
            {code:'17', alias:'Trọng Tiên', common:'Con Hạc', sub:'06'},
            {code:'18', alias:'Thiên Thân', common:'Kỳ Lân', sub:'10'},
            {code:'19', alias:'Cán Ngọc', common:'Con Bướm', sub:'27'},
            {code:'20', alias:'Trân Châu', common:'Hòn Đá', sub:'08'},
            {code:'21', alias:'Thượng Chiêu', common:'Con Én', sub:'22'},
            {code:'22', alias:'Song Đồng', common:'Con Cu', sub:'21'},
            {code:'23', alias:'Tam Hòe', common:'Con Khỉ', sub:'30'},
            {code:'24', alias:'Hiệp Hải', common:'Con Ếch', sub:'07'},
            {code:'25', alias:'Cửu Quan', common:'Con Quạ', sub:'35'},
            {code:'26', alias:'Thái Bình', common:'Rồng Nằm', sub:'31'},
            {code:'27', alias:'Hỏa Diệm', common:'Con Rùa', sub:'19'},
            {code:'28', alias:'Nhựt Thăng', common:'Con Gà', sub:'29'},
            {code:'29', alias:'Địa Lương', common:'Con Lươn', sub:'28'},
            {code:'30', alias:'Tỉnh Lợi', common:'Cá Đỏ', sub:'23'},
            {code:'31', alias:'Trường Thọ', common:'Con Tôm', sub:'26'},
            {code:'32', alias:'Vạn Kim', common:'Con Rắn', sub:'03'},
            {code:'33', alias:'Thanh Tiền', common:'Con Nhện', sub:'09'},
            {code:'34', alias:'Nguyên Kiết', common:'Con Nai', sub:'36'},
            {code:'35', alias:'Nhứt Phẩm', common:'Con Dê', sub:'25'},
            {code:'36', alias:'An Sỹ', common:'Con Yêu', sub:'34'}
        ];

        createApp({
            data() {
                return {
                    apiKey: localStorage.getItem('gemini_api_key') || '',
                    imageSrc: null,
                    isProcessing: false,
                    errorMessage: '',
                    animalDb: ANIMAL_DB,
                    form: {
                        sender_name: '', transaction_date: '', total_amount: 0,
                        receiver_name: '', receiver_bank: '', receiver_account: '',
                        bets: []
                    }
                }
            },
            watch: {
                apiKey(newVal) { 
                    if(newVal) localStorage.setItem('gemini_api_key', newVal.trim()); 
                }
            },
            computed: {
                sumBets() { return this.form.bets.reduce((acc, b) => acc + (b.amount_k || 0) * 1000, 0); },
                diff() { return (this.form.total_amount || 0) - this.sumBets; }
            },
            methods: {
                async handleFileUpload(e) {
                    const file = e.target.files[0];
                    if(!file) return;
                    
                    this.errorMessage = ''; // Reset lỗi
                    
                    // Kiểm tra Key
                    if(!this.apiKey || !this.apiKey.trim().startsWith('AIza')) {
                        this.errorMessage = "Khoá API chưa đúng. Vui lòng nhập Key bắt đầu bằng 'AIza' vào ô phía trên.";
                        return;
                    }

                    this.imageSrc = URL.createObjectURL(file);
                    this.isProcessing = true;
                    
                    try {
                        const base64Image = await this.fileToGenerativePart(file);
                        await this.analyzeImage(base64Image);
                    } catch (error) {
                        console.error("Lỗi:", error);
                        this.errorMessage = `Lỗi hệ thống: ${error.message}`;
                    } finally {
                        this.isProcessing = false;
                    }
                },

                async analyzeImage(imagePart) {
                    // Prompt cực kỳ chi tiết để ép AI làm đúng
                    const dbString = JSON.stringify(this.animalDb.map(a => `${a.code}/${a.sub} - ${a.alias} - ${a.common}`));
                    
                    const promptText = `
                    Hệ vai: Chuyên gia xử lý dữ liệu cá cược.
                    Nhiệm vụ: Trích xuất JSON từ ảnh biên lai ngân hàng/tin nhắn.
                    
                    DỮ LIỆU THAM CHIẾU (Mã Chính / Số Phụ - Tên Huý - Tên Thường):
                    ${dbString}

                    QUY TẮC MATCHING (Bắt buộc):
                    1. Đọc nội dung tin nhắn/biên lai (Message/Note).
                    2. Tìm các con vật được đặt cược. Nếu thấy "số phụ" (ví dụ 05), phải map về "Code chính" (01).
                    3. Tiền: "50", "50k", "50.000" đều là 50 (đơn vị nghìn).
                    
                    OUTPUT JSON FORMAT (Chỉ trả về JSON, không markdown):
                    {
                        "sender_name": "Tên người gửi (viết hoa)",
                        "transaction_date": "YYYY-MM-DDTHH:mm",
                        "total_amount": NUMBER (Ví dụ 150000),
                        "receiver_name": "Tên người nhận",
                        "receiver_bank": "Ngân hàng nhận",
                        "receiver_account": "Số TK nhận",
                        "bets": [
                            { "code": "STRING (01-36)", "common_name": "STRING", "matched_text": "STRING", "amount_k": NUMBER }
                        ]
                    }
                    `;

                    // TẮT BỘ LỌC AN TOÀN (QUAN TRỌNG NHẤT)
                    const safetySettings = [
                        { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                    ];

                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${this.apiKey.trim()}`;
                    
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: promptText }, imagePart] }],
                            safetySettings: safetySettings
                        })
                    });

                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.error?.message || "Lỗi kết nối đến Google Server");
                    }

                    const data = await response.json();
                    
                    // Kiểm tra block
                    if(!data.candidates || data.candidates.length === 0) {
                        throw new Error("AI không trả về kết quả (Có thể do bộ lọc nội dung còn sót lại).");
                    }

                    let text = data.candidates[0].content.parts[0].text;
                    text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                    
                    const result = JSON.parse(text);
                    
                    // Map vào Form
                    this.form = {
                        sender_name: result.sender_name || '',
                        transaction_date: result.transaction_date || new Date().toISOString().slice(0,16),
                        total_amount: result.total_amount || 0,
                        receiver_name: result.receiver_name || '',
                        receiver_bank: result.receiver_bank || '',
                        receiver_account: result.receiver_account || '',
                        bets: result.bets || []
                    };
                },

                fileToGenerativePart(file) {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onloadend = () => {
                            const base64String = reader.result.split(',')[1];
                            resolve({ inlineData: { data: base64String, mimeType: file.type } });
                        };
                        reader.readAsDataURL(file);
                    });
                },

                resetApp() {
                    this.imageSrc = null;
                    this.errorMessage = '';
                    this.form = { sender_name: '', transaction_date: '', total_amount: 0, bets: [] };
                },
                formatCurrency(val) { return val ? val.toLocaleString('vi-VN') : ''; },
                updateTotal(e) {
                    const raw = e.target.value.replace(/[^0-9]/g, '');
                    this.form.total_amount = raw ? parseInt(raw) : 0;
                },
                addBet(animal) {
                    this.form.bets.push({ code: animal.code, common_name: animal.common, matched_text: 'Thủ công', amount_k: 0 });
                },
                removeBet(idx) { this.form.bets.splice(idx, 1); },
                downloadExcel() {
                    let csv = "\uFEFFNgay,NguoiChuyen,NguoiNhan,NganHang,SoTK,TongTien,Ma,ConVat,Tien(k),ThanhTien\n";
                    const d = this.form.transaction_date.replace('T', ' ');
                    this.form.bets.forEach(b => {
                        csv += `"${d}","${this.form.sender_name}","${this.form.receiver_name}","${this.form.receiver_bank}","${this.form.receiver_account}",${this.form.total_amount},'${b.code},"${b.common_name}",${b.amount_k},${b.amount_k*1000}\n`;
                    });
                    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement("a");
                    link.href = url;
                    link.download = `BienLai_${this.form.sender_name}.csv`;
                    link.click();
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
