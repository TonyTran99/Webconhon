<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Đối Soát V6 (Tốc Độ Cao)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src='https://unpkg.com/tesseract.js@v5/dist/tesseract.min.js'></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f1f5f9; }
        /* Tùy chỉnh thanh cuộn */
        .scroller::-webkit-scrollbar { width: 6px; }
        .scroller::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        
        /* Hiệu ứng loading */
        .loader {
            border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%;
            width: 20px; height: 20px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Input focus effect */
        input:focus, textarea:focus { outline: 2px solid #3b82f6; border-color: transparent; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-800">

    <header class="bg-slate-900 text-white px-4 py-3 shadow-md flex justify-between items-center z-30">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 p-2 rounded-lg"><i class="fa-solid fa-bolt text-white"></i></div>
            <div>
                <h1 class="text-lg font-bold uppercase leading-none">Đối Soát Siêu Tốc V6</h1>
                <div class="text-[10px] text-slate-400 mt-1">Công nghệ nén ảnh & Xử lý đen trắng</div>
            </div>
        </div>
        <button @click="resetApp" class="bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded text-xs font-bold transition flex items-center gap-2">
            <i class="fa-solid fa-rotate"></i> Làm mới
        </button>
    </header>

    <div id="app" class="flex-1 flex overflow-hidden">
        
        <div class="w-5/12 bg-white border-r border-slate-200 flex flex-col relative z-20">
            <div class="flex border-b text-sm font-bold text-slate-500">
                <button @click="mode='image'" :class="{'text-blue-600 border-b-2 border-blue-600 bg-blue-50': mode==='image'}" class="flex-1 py-3 hover:bg-slate-50">
                    <i class="fa-solid fa-image mr-1"></i> Quét Ảnh (OCR)
                </button>
                <button @click="mode='text'" :class="{'text-purple-600 border-b-2 border-purple-600 bg-purple-50': mode==='text'}" class="flex-1 py-3 hover:bg-slate-50">
                    <i class="fa-solid fa-paste mr-1"></i> Dán Văn Bản (Nhanh)
                </button>
            </div>

            <div v-show="mode==='image'" class="flex-1 flex flex-col p-4 overflow-hidden">
                <div class="flex-1 border-2 border-dashed border-slate-300 rounded-xl bg-slate-50 flex flex-col items-center justify-center relative overflow-hidden group">
                    
                    <div v-if="!imageSrc" class="text-center p-6">
                        <i class="fa-solid fa-cloud-arrow-up text-5xl text-slate-300 mb-3"></i>
                        <p class="text-sm font-bold text-slate-500">Chọn ảnh biên lai</p>
                        <p class="text-[10px] text-slate-400 mb-4">(Hệ thống sẽ tự động nén để quét nhanh hơn)</p>
                        <label class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-full cursor-pointer shadow-lg transition transform hover:-translate-y-1 font-bold text-sm">
                            Tải Ảnh Lên
                            <input type="file" @change="handleFileUpload" accept="image/*" class="hidden">
                        </label>
                    </div>

                    <img v-else :src="imageSrc" class="w-full h-full object-contain cursor-zoom-in transition-transform duration-300" alt="Receipt">
                    
                    <div v-if="isProcessing" class="absolute inset-0 bg-black/60 flex flex-col items-center justify-center text-white z-10 backdrop-blur-sm">
                        <div class="loader mb-3"></div>
                        <div class="text-xs font-bold">Đang phân tích... {{ progress }}%</div>
                        <div class="text-[10px] opacity-70 mt-1">{{ statusMessage }}</div>
                    </div>
                </div>
                
                <canvas ref="canvas" class="hidden"></canvas>
            </div>

            <div v-show="mode==='text'" class="flex-1 flex flex-col p-4">
                <textarea v-model="rawText" placeholder="Dán nội dung tin nhắn hoặc copy chữ từ ảnh vào đây..." 
                    class="w-full h-full p-4 border rounded-xl resize-none text-sm bg-slate-50 focus:bg-white transition"></textarea>
                <button @click="parseText(rawText)" class="mt-3 w-full bg-purple-600 text-white py-3 rounded-lg font-bold shadow hover:bg-purple-700">
                    <i class="fa-solid fa-wand-magic-sparkles mr-2"></i> Phân Tích Ngay
                </button>
            </div>
        </div>

        <div class="w-7/12 bg-slate-100 flex flex-col relative">
            <div class="flex-1 overflow-y-auto scroller p-6 pb-24">
                
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 mb-6 overflow-hidden">
                    <div class="bg-slate-50 border-b px-4 py-3 flex justify-between items-center">
                        <h3 class="font-bold text-sm text-slate-700 uppercase">1. Thông tin giao dịch</h3>
                        <span v-if="isValidHeader" class="text-green-600 text-[10px] font-bold bg-green-100 px-2 py-1 rounded"><i class="fa-solid fa-check"></i> Đủ thông tin</span>
                        <span v-else class="text-orange-600 text-[10px] font-bold bg-orange-100 px-2 py-1 rounded"><i class="fa-solid fa-triangle-exclamation"></i> Kiểm tra lại</span>
                    </div>
                    <div class="p-4 grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Người chuyển</label>
                            <input v-model="form.sender" class="w-full p-2 border rounded text-sm font-semibold" placeholder="Tên khách hàng">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Ngày giờ</label>
                            <input type="datetime-local" v-model="form.date" class="w-full p-2 border rounded text-sm">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Tổng tiền biên lai</label>
                            <div class="relative">
                                <input type="text" :value="formatCurrency(form.total)" @input="updateTotal" 
                                    class="w-full p-2 border-2 border-blue-100 bg-blue-50 rounded text-lg font-bold text-blue-700 text-right pr-10 focus:border-blue-500" placeholder="0">
                                <span class="absolute right-3 top-3 text-xs font-bold text-blue-400">VNĐ</span>
                            </div>
                        </div>
                        <div class="col-span-2 grid grid-cols-3 gap-2 mt-2 pt-2 border-t border-dashed">
                            <div class="col-span-3 text-[10px] font-bold text-slate-400 uppercase mb-1">Thông tin người nhận (Bên nhận)</div>
                            <input v-model="form.receiver" class="p-2 border rounded text-xs" placeholder="Tên người nhận">
                            <input v-model="form.receiverBank" class="p-2 border rounded text-xs" placeholder="Ngân hàng">
                            <input v-model="form.receiverAcc" class="p-2 border rounded text-xs" placeholder="Số TK">
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 mb-6">
                    <div class="bg-indigo-50 border-b border-indigo-100 px-4 py-3 flex justify-between items-center">
                        <h3 class="font-bold text-sm text-indigo-900 uppercase">2. Danh sách cược</h3>
                        <div class="text-xs font-bold text-indigo-700">Đã quét: {{ form.bets.length }} mã</div>
                    </div>

                    <table class="w-full text-sm">
                        <thead class="bg-slate-50 text-slate-500 text-[10px] uppercase border-b">
                            <tr>
                                <th class="p-3 text-left">Mã & Tên</th>
                                <th class="p-3 text-right">Số tiền (k)</th>
                                <th class="p-3 text-right">Thành tiền</th>
                                <th class="p-3 text-center w-10">Xóa</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            <tr v-for="(bet, index) in form.bets" :key="index" class="hover:bg-slate-50">
                                <td class="p-3">
                                    <div class="font-bold text-slate-700">{{ bet.code }} - {{ bet.common }}</div>
                                    <div class="text-[10px] text-slate-400 italic">{{ bet.alias }}</div>
                                </td>
                                <td class="p-3 text-right">
                                    <input type="number" v-model="bet.amount_k" class="w-16 text-right p-1 border rounded font-mono text-sm bg-slate-50 focus:bg-white">
                                </td>
                                <td class="p-3 text-right font-mono font-medium">
                                    {{ (bet.amount_k * 1000).toLocaleString('vi-VN') }}
                                </td>
                                <td class="p-3 text-center">
                                    <button @click="removeBet(index)" class="text-slate-300 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="p-3 bg-slate-50 border-t">
                        <div class="text-[10px] font-bold text-slate-400 uppercase mb-2">Thêm thủ công (nếu quét sót):</div>
                        <div class="grid grid-cols-6 lg:grid-cols-9 gap-1 h-24 overflow-y-auto scroller pr-1">
                            <button v-for="animal in animalDb" :key="animal.code" @click="addBet(animal)" 
                                class="bg-white border hover:border-indigo-500 hover:bg-indigo-50 rounded p-1 flex flex-col items-center transition">
                                <span class="font-bold text-[10px] text-indigo-700">{{ animal.code }}</span>
                                <span class="text-[9px] text-slate-500 truncate w-full text-center">{{ animal.common }}</span>
                            </button>
                        </div>
                    </div>
                </div>

            </div>

            <div class="absolute bottom-0 left-0 right-0 bg-white border-t p-4 shadow-[0_-5px_15px_rgba(0,0,0,0.05)] z-30">
                <div class="flex items-center gap-4">
                    <div class="flex-1">
                        <div class="text-[10px] font-bold text-slate-400 uppercase">Chênh lệch tiền</div>
                        <div class="flex items-center gap-2">
                            <span class="text-2xl font-black" :class="diff === 0 ? 'text-green-600' : 'text-red-600'">
                                {{ diff > 0 ? '+' : '' }}{{ diff.toLocaleString('vi-VN') }} ₫
                            </span>
                            <span v-if="diff === 0" class="px-2 py-0.5 bg-green-100 text-green-700 text-[10px] font-bold rounded uppercase">Khớp lệnh</span>
                            <span v-else class="px-2 py-0.5 bg-red-100 text-red-700 text-[10px] font-bold rounded uppercase">Lệch</span>
                        </div>
                    </div>
                    
                    <button @click="downloadExcel" :disabled="diff !== 0" 
                        class="bg-blue-600 hover:bg-blue-700 disabled:bg-slate-300 disabled:cursor-not-allowed text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-blue-200 transition-all flex items-center gap-2">
                        <span>XÁC NHẬN</span>
                        <i class="fa-solid fa-arrow-right"></i>
                    </button>
                </div>
            </div>

        </div>
    </div>

    <script>
        const { createApp } = Vue;

        // DỮ LIỆU 36 CON (Full Keywords)
        const ANIMAL_DB = [
            {code:'01', common:'Cá Trắng', keywords:['ca trang', 'chiem khoi', 'trang', '01']},
            {code:'02', common:'Con Ốc', keywords:['con oc', 'ban que', 'oc', '02']},
            {code:'03', common:'Con Ngỗng', keywords:['con ngong', 'vinh sanh', 'ngong', '03']},
            {code:'10', common:'Rồng Bay', keywords:['rong bay', 'giang tu', 'rong', '10']},
            {code:'22', common:'Con Cu', keywords:['con cu', 'song dong', 'chim cu', 'cu', '22']},
            {code:'30', common:'Cá Đỏ', keywords:['ca do', 'tinh loi', 'do', '30']},
            {code:'36', common:'Con Yêu', keywords:['con yeu', 'an sy', 'yeu', '36']}
            // ... Bạn hãy điền nốt các con còn lại vào đây
        ];

        createApp({
            data() {
                return {
                    mode: 'image', // 'image' or 'text'
                    imageSrc: null,
                    rawText: '',
                    isProcessing: false,
                    progress: 0,
                    statusMessage: '',
                    animalDb: ANIMAL_DB,
                    form: {
                        sender: '', date: '', total: 0,
                        receiver: '', receiverBank: '', receiverAcc: '',
                        bets: []
                    }
                }
            },
            computed: {
                sumBets() { return this.form.bets.reduce((acc, b) => acc + (b.amount_k || 0) * 1000, 0); },
                diff() { return (this.form.total || 0) - this.sumBets; },
                isValidHeader() { return this.form.sender && this.form.total > 0; }
            },
            methods: {
                // --- XỬ LÝ ẢNH CAO CẤP (Pre-processing) ---
                async handleFileUpload(e) {
                    const file = e.target.files[0];
                    if(!file) return;

                    this.imageSrc = URL.createObjectURL(file);
                    this.resetData();
                    this.isProcessing = true;
                    this.statusMessage = "Đang nén ảnh...";

                    // 1. Nén ảnh và chuyển đen trắng
                    const processedDataUrl = await this.preprocessImage(file);
                    
                    // 2. Gửi vào Tesseract
                    this.runOCR(processedDataUrl);
                },

                preprocessImage(file) {
                    return new Promise((resolve) => {
                        const img = new Image();
                        img.src = URL.createObjectURL(file);
                        img.onload = () => {
                            const canvas = this.$refs.canvas;
                            const ctx = canvas.getContext('2d');
                            
                            // Resize: Giới hạn chiều rộng max 1000px để tăng tốc độ 500%
                            const MAX_WIDTH = 1000;
                            const scale = MAX_WIDTH / img.width;
                            canvas.width = MAX_WIDTH;
                            canvas.height = img.height * scale;
                            
                            // Vẽ ảnh đã resize
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            
                            // Chuyển sang Grayscale (Đen trắng) để AI đọc chữ rõ hơn
                            const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            const data = imgData.data;
                            for (let i = 0; i < data.length; i += 4) {
                                const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                                data[i] = avg; // Red
                                data[i + 1] = avg; // Green
                                data[i + 2] = avg; // Blue
                                // Tăng độ tương phản (Thresholding đơn giản)
                                const contrast = avg > 128 ? 255 : 0;
                                data[i] = contrast;
                                data[i+1] = contrast;
                                data[i+2] = contrast;
                            }
                            ctx.putImageData(imgData, 0, 0);
                            
                            resolve(canvas.toDataURL('image/jpeg', 0.8)); // Xuất ảnh nén
                        };
                    });
                },

                async runOCR(imgUrl) {
                    this.statusMessage = "Khởi động AI...";
                    try {
                        const worker = await Tesseract.createWorker({
                            logger: m => {
                                if(m.status === 'recognizing text') {
                                    this.progress = Math.round(m.progress * 100);
                                    this.statusMessage = `Đang đọc chữ: ${this.progress}%`;
                                } else {
                                    this.statusMessage = m.status;
                                }
                            }
                        });
                        
                        await worker.loadLanguage('vie');
                        await worker.initialize('vie');
                        // Thiết lập chỉ nhận diện các ký tự cần thiết để tăng tốc
                        await worker.setParameters({
                            tessedit_char_whitelist: '0123456789aAàÀảẢãÃáÁạẠăĂằẰẳẲẵẴắẮặẶâÂầẦẩẨẫÃấẤậẬbBcCdDđĐeEèÈẻẺẽẼéÉẹẸêÊềỀểỂễỄếẾệỆfFgGhHiIìÌỉỈĩĨíÍịỊjJkKlLmMnNoOòÒỏỎõÕóÓọỌôÔồỒổỔỗỖốỐộỘơƠờỜởỞỡỠớỚợỢpPqQrRsStTuUùÙủỦũŨúÚụỤưƯừỪửỬữỮứỨựỰvVwWxXyYỳỲỷỶỹỸýÝỵỴzZ:,.-/ ',
                        });

                        const { data: { text } } = await worker.recognize(imgUrl);
                        await worker.terminate();
                        
                        this.parseText(text);

                    } catch (err) {
                        alert("Lỗi OCR: " + err.message);
                    } finally {
                        this.isProcessing = false;
                    }
                },

                // --- BỘ NÃO PHÂN TÍCH (Parser Logic) ---
                parseText(raw) {
                    const text = raw.toLowerCase().replace(/\n/g, ' ').replace(/\./g, '').replace(/,/g, '');
                    
                    // 1. Tìm Tổng tiền (Số lớn nhất > 10.000)
                    const numbers = text.match(/\d+/g);
                    if(numbers) {
                        const amounts = numbers.map(n => parseInt(n)).filter(n => n > 10000);
                        if(amounts.length > 0) this.form.total = Math.max(...amounts);
                    }

                    // 2. Tìm ngày giờ (DD/MM hoặc HH:MM)
                    const now = new Date();
                    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                    this.form.date = now.toISOString().slice(0,16);

                    // 3. Tìm Bets
                    this.form.bets = [];
                    this.animalDb.forEach(animal => {
                        for(let kw of animal.keywords) {
                            // Regex tìm: keyword + khoảng trắng/ký tự + số (k)
                            // Ví dụ: "ca trang 50", "ca trang: 50k"
                            const regex = new RegExp(`${kw}\\s*[:\-]?\\s*(\\d+)(k?)`, 'i');
                            const match = text.match(regex);
                            
                            if(match) {
                                let val = parseInt(match[1]);
                                // Logic chuẩn hoá tiền: Nếu < 1000 thì là nghìn, nếu > 1000 thì chia 1000
                                if(val >= 1000) val = val / 1000;
                                
                                const exists = this.form.bets.find(b => b.code === animal.code);
                                if(!exists) {
                                    this.form.bets.push({
                                        code: animal.code,
                                        common: animal.common,
                                        alias: kw, // Từ khoá tìm thấy
                                        amount_k: val
                                    });
                                }
                                break; 
                            }
                        }
                    });
                },

                // --- UI Helpers ---
                resetData() {
                    this.form = { sender: '', date: '', total: 0, receiver: '', receiverBank: '', receiverAcc: '', bets: [] };
                    this.imageSrc = null;
                },
                resetApp() {
                    this.resetData();
                    this.mode = 'image';
                    this.rawText = '';
                },
                formatCurrency(val) { return val ? val.toLocaleString('vi-VN') : ''; },
                updateTotal(e) {
                    const raw = e.target.value.replace(/[^0-9]/g, '');
                    this.form.total = raw ? parseInt(raw) : 0;
                },
                addBet(animal) {
                    this.form.bets.push({ code: animal.code, common: animal.common, alias: 'Thủ công', amount_k: 0 });
                },
                removeBet(idx) { this.form.bets.splice(idx, 1); },
                
                downloadExcel() {
                    let csv = "\uFEFFNgay,NguoiChuyen,NguoiNhan,NganHang,SoTK,TongTien,Ma,ConVat,Tien(k),ThanhTien\n";
                    const d = this.form.date.replace('T', ' ');
                    this.form.bets.forEach(b => {
                        csv += `"${d}","${this.form.sender}","${this.form.receiver}","${this.form.receiverBank}","${this.form.receiverAcc}",${this.form.total},'${b.code},"${b.common}",${b.amount_k},${b.amount_k*1000}\n`;
                    });
                    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement("a");
                    link.href = url;
                    link.download = `KetQua_${Date.now()}.csv`;
                    link.click();
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
